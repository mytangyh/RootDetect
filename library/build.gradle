plugins {
    id 'com.android.library'
    id 'org.jetbrains.kotlin.android'
}

android {
    namespace 'com.example.library'
    compileSdk 33

    defaultConfig {
        minSdk 24

        testInstrumentationRunner "androidx.test.runner.AndroidJUnitRunner"
        consumerProguardFiles "consumer-rules.pro"
        externalNativeBuild {
            cmake {
                cppFlags ''
            }
        }
    }
    externalNativeBuild {
        cmake {
            path 'src/main/cpp/CMakeLists.txt'
            version '3.18.1'
        }
    }

    buildTypes {
        release {
            minifyEnabled false
            proguardFiles getDefaultProguardFile('proguard-android-optimize.txt'), 'proguard-rules.pro'
        }
    }

    compileOptions {
        sourceCompatibility JavaVersion.VERSION_1_8
        targetCompatibility JavaVersion.VERSION_1_8
    }

    kotlinOptions {
        jvmTarget = '1.8'
    }
}

// å¤åˆ¶ armeabi-v7a åˆ° armeabi
task copySoFilesToArmeabi {
    doLast {
        println "====== ðŸš€ å¼€å§‹å¤åˆ¶ SO æ–‡ä»¶åˆ° armeabi ======"

        // èŽ·å– CMake ç”Ÿæˆçš„ SO æ–‡ä»¶è·¯å¾„ï¼ˆDebug å’Œ Releaseï¼‰
        def cmakeRoot = file("${buildDir}/intermediates/cxx")
        def possibleSourceDirs = cmakeRoot.listFiles()?.collect { it.absolutePath } ?: []
        possibleSourceDirs += ["${projectDir}/src/main/jniLibs/armeabi-v7a"]

        // ç›®æ ‡ç›®å½•
        def jniLibsDir = file("${projectDir}/src/main/jniLibs")
        def armeabiDir = new File(jniLibsDir, "armeabi")
        if (!armeabiDir.exists()) {
            armeabiDir.mkdirs()
        }

        def foundFiles = false

        // éåŽ†æ‰€æœ‰å¯èƒ½çš„ `armeabi-v7a` ç›®å½•ï¼ŒæŸ¥æ‰¾ `so` æ–‡ä»¶
        possibleSourceDirs.each { sourceBasePath ->
            def v7aDirs = fileTree(dir: sourceBasePath).matching { include("**/armeabi-v7a/**") }
            v7aDirs.each { v7aDir ->
                def soFiles = fileTree(dir: v7aDir).matching { include("*.so") }
                if (soFiles.files.size() > 0) {
                    println "âœ… åœ¨ ${v7aDir} ä¸­æ‰¾åˆ° ${soFiles.files.size()} ä¸ª SO æ–‡ä»¶"
                    foundFiles = true

                    // å¤åˆ¶åˆ° `armeabi` ç›®å½•
                    soFiles.each { soFile ->
                        def targetFile = new File(armeabiDir, soFile.name)
                        println "ðŸ“Œ å¤åˆ¶: ${soFile} -> ${targetFile}"

                        soFile.withInputStream { input ->
                            targetFile.withOutputStream { output ->
                                output << input
                            }
                        }
                    }
                }
            }
        }

        if (!foundFiles) {
            println "âŒ è­¦å‘Š: æ²¡æœ‰æ‰¾åˆ°ä»»ä½• SO æ–‡ä»¶!"
        }

        println "====== ðŸŽ¯ SO æ–‡ä»¶å¤åˆ¶æ“ä½œå®Œæˆ ======"
    }
}


// **CMake ä»»åŠ¡å®ŒæˆåŽï¼Œå¿…é¡»å…ˆæ‰§è¡Œ `copySoFilesToArmeabi`**
afterEvaluate {
    tasks.findAll { task ->
        task.name.startsWith("externalNativeBuild")
    }.each { nativeTask ->
        copySoFilesToArmeabi.mustRunAfter(nativeTask)
    }

    // 2. æ‰€æœ‰ JNI åˆå¹¶ä»»åŠ¡å¿…é¡»ä¾èµ– copySoFilesToArmeabi
    tasks.findAll { task ->
        task.name.startsWith("merge") && task.name.endsWith("Libs")
    }.each { mergeTask ->
        mergeTask.dependsOn(copySoFilesToArmeabi)
    }
}

dependencies {
    implementation 'androidx.core:core-ktx:1.9.0'
    implementation 'androidx.appcompat:appcompat:1.6.1'
    implementation 'com.google.android.material:material:1.9.0'
    testImplementation 'junit:junit:4.13.2'
    androidTestImplementation 'androidx.test.ext:junit:1.1.5'
    androidTestImplementation 'androidx.test.espresso:espresso-core:3.5.1'
    implementation "androidx.viewpager2:viewpager2:1.0.0"
}